<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Group 12 - Join External and Comment Data</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Group 12</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./Intro.html" rel="" target="">
 <span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./eda.html" rel="" target="">
 <span class="menu-text">EDA</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./nlp.html" rel="" target="">
 <span class="menu-text">NLP</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./ml.html" rel="" target="">
 <span class="menu-text">ML</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./summary.html" rel="" target="">
 <span class="menu-text">Summary</span></a>
  </li>  
</ul>
            <div class="quarto-navbar-tools ms-auto">
</div>
          </div> <!-- /navcollapse -->
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#pull-and-clean-external-btc-data" id="toc-pull-and-clean-external-btc-data" class="nav-link active" data-scroll-target="#pull-and-clean-external-btc-data">Pull and Clean External BTC Data</a></li>
  <li><a href="#join-with-nlp-comment-data" id="toc-join-with-nlp-comment-data" class="nav-link" data-scroll-target="#join-with-nlp-comment-data">Join with NLP Comment Data</a></li>
  <li><a href="#pipeline-in-spark" id="toc-pipeline-in-spark" class="nav-link" data-scroll-target="#pipeline-in-spark">Pipeline in Spark</a></li>
  <li><a href="#building-train-test-val-datasets" id="toc-building-train-test-val-datasets" class="nav-link" data-scroll-target="#building-train-test-val-datasets">Building train-test-val datasets</a>
  <ul class="collapse">
  <li><a href="#fit-pipeline-on-train-data-to-avoid-information-leak" id="toc-fit-pipeline-on-train-data-to-avoid-information-leak" class="nav-link" data-scroll-target="#fit-pipeline-on-train-data-to-avoid-information-leak">Fit pipeline on train data to avoid information leak</a></li>
  </ul></li>
  <li><a href="#build-classification-models-logistic-regression-gbt" id="toc-build-classification-models-logistic-regression-gbt" class="nav-link" data-scroll-target="#build-classification-models-logistic-regression-gbt">Build Classification Models (logistic regression, GBT)</a>
  <ul class="collapse">
  <li><a href="#classification-evaluation-metrics" id="toc-classification-evaluation-metrics" class="nav-link" data-scroll-target="#classification-evaluation-metrics">Classification Evaluation Metrics</a></li>
  </ul></li>
  <li><a href="#build-regression-models" id="toc-build-regression-models" class="nav-link" data-scroll-target="#build-regression-models">Build Regression Models</a>
  <ul class="collapse">
  <li><a href="#linear-regression" id="toc-linear-regression" class="nav-link" data-scroll-target="#linear-regression">Linear Regression</a></li>
  <li><a href="#gradient-boosted-regressor" id="toc-gradient-boosted-regressor" class="nav-link" data-scroll-target="#gradient-boosted-regressor">Gradient Boosted Regressor</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Join External and Comment Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Setup - Run only once per Kernel App</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>conda install https:<span class="op">//</span>anaconda.org<span class="op">/</span>conda<span class="op">-</span>forge<span class="op">/</span>openjdk<span class="op">/</span><span class="fl">11.0.1</span><span class="op">/</span>download<span class="op">/</span>linux<span class="op">-</span><span class="dv">64</span><span class="op">/</span>openjdk<span class="op">-</span><span class="fl">11.0.1</span><span class="op">-</span>hacce0ff_1021.tar.bz2</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># install PySpark</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="op">%</span>pip install pyspark<span class="op">==</span><span class="fl">3.4.0</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># restart kernel</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.core.display <span class="im">import</span> HTML</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>HTML(<span class="st">"&lt;script&gt;Jupyter.notebook.kernel.restart()&lt;/script&gt;"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
Downloading and Extracting Packages:


## Package Plan ##

  environment location: /opt/conda

  added / updated specs:
    - conda-forge/openjdk/11.0.1/download/linux-64::openjdk==11.0.1=hacce0ff_1021


The following NEW packages will be INSTALLED:

  openjdk            conda-forge/openjdk/11.0.1/download/linux-64::openjdk-11.0.1-hacce0ff_1021 



Downloading and Extracting Packages:

Preparing transaction: done
Verifying transaction: done
Executing transaction: done

Note: you may need to restart the kernel to use updated packages.
Collecting pyspark==3.4.0
  Using cached pyspark-3.4.0-py2.py3-none-any.whl
Requirement already satisfied: py4j==0.10.9.7 in /opt/conda/lib/python3.11/site-packages (from pyspark==3.4.0) (0.10.9.7)
Installing collected packages: pyspark
Successfully installed pyspark-3.4.0
Note: you may need to restart the kernel to use updated packages.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<script>Jupyter.notebook.kernel.restart()</script>
</div>
</div>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sagemaker</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> functions <span class="im">as</span> f</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>sess <span class="op">=</span> sagemaker.Session()</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> sess.default_bucket()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>sagemaker.config INFO - Not applying SDK defaults from location: /etc/xdg/sagemaker/config.yaml
sagemaker.config INFO - Not applying SDK defaults from location: /home/sagemaker-user/.config/sagemaker/config.yaml</code></pre>
</div>
</div>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> (</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    SparkSession.builder.appName(<span class="st">"PySparkApp"</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    .config(<span class="st">"spark.jars.packages"</span>, <span class="st">"org.apache.hadoop:hadoop-aws:3.2.2"</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    .config(</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"fs.s3a.aws.credentials.provider"</span>,</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"com.amazonaws.auth.ContainerCredentialsProvider"</span>,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    .getOrCreate()</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(spark.version)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: Ignoring non-Spark config property: fs.s3a.aws.credentials.provider
Ivy Default Cache set to: /home/sagemaker-user/.ivy2/cache
The jars for the packages stored in: /home/sagemaker-user/.ivy2/jars
org.apache.hadoop#hadoop-aws added as a dependency
:: resolving dependencies :: org.apache.spark#spark-submit-parent-d0b47657-4fe9-4512-b7ee-3f56686220c8;1.0
    confs: [default]
    found org.apache.hadoop#hadoop-aws;3.2.2 in central
    found com.amazonaws#aws-java-sdk-bundle;1.11.563 in central
:: resolution report :: resolve 230ms :: artifacts dl 7ms
    :: modules in use:
    com.amazonaws#aws-java-sdk-bundle;1.11.563 from central in [default]
    org.apache.hadoop#hadoop-aws;3.2.2 from central in [default]
    ---------------------------------------------------------------------
    |                  |            modules            ||   artifacts   |
    |       conf       | number| search|dwnlded|evicted|| number|dwnlded|
    ---------------------------------------------------------------------
    |      default     |   2   |   0   |   0   |   0   ||   2   |   0   |
    ---------------------------------------------------------------------
:: retrieving :: org.apache.spark#spark-submit-parent-d0b47657-4fe9-4512-b7ee-3f56686220c8
    confs: [default]
    0 artifacts copied, 2 already retrieved (0kB/7ms)
24/12/07 06:45:34 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable
Setting default log level to "WARN".
To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>:: loading settings :: url = jar:file:/opt/conda/lib/python3.11/site-packages/pyspark/jars/ivy-2.5.1.jar!/org/apache/ivy/core/settings/ivysettings.xml
3.4.0</code></pre>
</div>
</div>
<section id="pull-and-clean-external-btc-data" class="level3">
<h3 class="anchored" data-anchor-id="pull-and-clean-external-btc-data">Pull and Clean External BTC Data</h3>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>spark.conf.<span class="bu">set</span>(<span class="st">"spark.sql.legacy.timeParserPolicy"</span>, <span class="st">"LEGACY"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>btc_in <span class="op">=</span> spark.read.options(header<span class="op">=</span><span class="st">'True'</span>, inferSchema<span class="op">=</span><span class="st">'True'</span>, delimiter<span class="op">=</span><span class="st">','</span>).csv(<span class="st">"./btc_data_clean.csv"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>clean_btc <span class="op">=</span> btc_in.withColumn(<span class="st">"prediction_date"</span>, f.from_unixtime(f.unix_timestamp(f.col(<span class="st">'prediction_date'</span>), <span class="st">'M/dd/yyy'</span>))) <span class="op">\</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>                .withColumn(<span class="st">'day'</span>, f.dayofmonth(<span class="st">'prediction_date'</span>)) <span class="op">\</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>                .withColumn(<span class="st">'month'</span>, f.month(<span class="st">'prediction_date'</span>)) <span class="op">\</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>                .withColumn(<span class="st">'year'</span>, f.year(<span class="st">'prediction_date'</span>))</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>cols_to_keep <span class="op">=</span> [<span class="st">'Volatility'</span>,<span class="st">'Increase'</span>,<span class="st">'day'</span>,<span class="st">'month'</span>,<span class="st">'year'</span>]</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>selected_cols <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> clean_btc.columns <span class="cf">if</span> col <span class="kw">in</span> cols_to_keep]</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>clean_btc_ready <span class="op">=</span> clean_btc.select(selected_cols).toPandas()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
</section>
<section id="join-with-nlp-comment-data" class="level3">
<h3 class="anchored" data-anchor-id="join-with-nlp-comment-data">Join with NLP Comment Data</h3>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>comments_in <span class="op">=</span> pd.read_csv(<span class="st">'./NLP_output_for_ml.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>full_data <span class="op">=</span> pd.merge(comments_in, clean_btc_ready, left_on <span class="op">=</span> [<span class="st">'day'</span>,<span class="st">'month'</span>,<span class="st">'year'</span>], right_on <span class="op">=</span> [<span class="st">'day'</span>,<span class="st">'month'</span>,<span class="st">'year'</span>]) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>full_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Unnamed: 0</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">month</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">total</th>
<th data-quarto-table-cell-role="th">postotal</th>
<th data-quarto-table-cell-role="th">negtotal</th>
<th data-quarto-table-cell-role="th">neutotal</th>
<th data-quarto-table-cell-role="th">snpcomments</th>
<th data-quarto-table-cell-role="th">fedcomments</th>
<th data-quarto-table-cell-role="th">cryptocomments</th>
<th data-quarto-table-cell-role="th">Volatility</th>
<th data-quarto-table-cell-role="th">Increase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>2024</td>
<td>3</td>
<td>19</td>
<td>8</td>
<td>6</td>
<td>2</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>3</td>
<td>0.115697</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>1</td>
<td>2023</td>
<td>9</td>
<td>4</td>
<td>24</td>
<td>11</td>
<td>11</td>
<td>2</td>
<td>1</td>
<td>1</td>
<td>6</td>
<td>0.010366</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>2023</td>
<td>6</td>
<td>29</td>
<td>10</td>
<td>5</td>
<td>5</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0.051272</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>3</td>
<td>2023</td>
<td>8</td>
<td>10</td>
<td>21</td>
<td>14</td>
<td>7</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0.009294</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>4</td>
<td>2023</td>
<td>7</td>
<td>4</td>
<td>6</td>
<td>1</td>
<td>3</td>
<td>2</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0.020875</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="pipeline-in-spark" class="level2">
<h2 class="anchored" data-anchor-id="pipeline-in-spark">Pipeline in Spark</h2>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql.types <span class="im">import</span> FloatType</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="co">#comments_in = spark.read.options(header='True', inferSchema='True', delimiter=',').csv("./NLP_output_for_ml.csv")</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>full_spark_raw <span class="op">=</span> spark.createDataFrame(full_data).withColumn(<span class="st">'Volatility'</span>, f.col(<span class="st">'Volatility'</span>).cast(FloatType()) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>full_spark_raw.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 3:&gt;                                                          (0 + 1) / 1]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+
|Unnamed: 0|year|month|day|total|postotal|negtotal|neutotal|snpcomments|fedcomments|cryptocomments| Volatility|Increase|
+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+
|         0|2024|    3| 19|    8|       6|       2|       0|          0|          0|             3| 0.11569654|       1|
|         1|2023|    9|  4|   24|      11|      11|       2|          1|          1|             6|0.010366165|       0|
|         2|2023|    6| 29|   10|       5|       5|       0|          0|          0|             0|0.051271606|       1|
|         3|2023|    8| 10|   21|      14|       7|       0|          0|          0|             1|0.009294065|       0|
|         4|2023|    7|  4|    6|       1|       3|       2|          0|          1|             0|0.020875178|       0|
|         5|2023|    8| 14|   30|      26|       3|       1|          0|          0|             3|0.012009502|       0|
|         6|2023|    7|  2|   10|       4|       6|       0|          0|          0|             1|0.025981873|       1|
|         7|2023|    7| 20|   30|      15|      14|       1|          0|          0|             4|0.010704339|       1|
|         8|2023|    8| 31|   22|      14|       5|       3|          0|          0|             4| 0.03018702|       0|
|         9|2023|    7| 22|   23|      12|       8|       3|          0|          0|             1|0.020185372|       1|
|        10|2023|    8| 22|   25|      13|      11|       1|          0|          0|             4| 0.03821135|       1|
|        11|2023|    7|  5|    8|       3|       5|       0|          0|          1|             1|0.052260034|       0|
|        12|2023|    9| 16|   23|      14|       7|       2|          1|          0|             6|0.007744146|       0|
|        13|2024|    7|  5|    6|       2|       4|       0|          0|          0|             3| 0.04299435|       1|
|        14|2023|    8| 11|   25|      15|       9|       1|          0|          0|             4|0.003582499|       1|
|        15|2023|    9| 23|   18|      12|       5|       1|          0|          0|             6|0.021272434|       0|
|        16|2023|    9| 27|   19|      11|       6|       2|          0|          0|             2|0.035808284|       1|
|        17|2023|    9| 11|   25|      15|      10|       0|          1|          0|             4|0.053209834|       1|
|        18|2023|    8|  9|   35|      22|      12|       1|          0|          0|             6|0.011559267|       0|
|        19|2023|    7| 26|   25|      15|       8|       2|          0|          0|             4|0.016175574|       0|
+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+
only showing top 20 rows
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>full_spark_raw.printSchema()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>root
 |-- Unnamed: 0: long (nullable = true)
 |-- year: long (nullable = true)
 |-- month: long (nullable = true)
 |-- day: long (nullable = true)
 |-- total: long (nullable = true)
 |-- postotal: long (nullable = true)
 |-- negtotal: long (nullable = true)
 |-- neutotal: long (nullable = true)
 |-- snpcomments: long (nullable = true)
 |-- fedcomments: long (nullable = true)
 |-- cryptocomments: long (nullable = true)
 |-- Volatility: float (nullable = true)
 |-- Increase: long (nullable = true)
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.linalg <span class="im">import</span> Vectors</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> VectorAssembler</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a><span class="co"># select only the predictor columns we want in our model</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>vectorAssembler_features <span class="op">=</span> VectorAssembler(inputCols <span class="op">=</span> [<span class="st">'postotal'</span>,<span class="st">'negtotal'</span>,<span class="st">'neutotal'</span>,<span class="st">'snpcomments'</span>,<span class="st">'fedcomments'</span>,<span class="st">'cryptocomments'</span>], outputCol <span class="op">=</span> <span class="st">'features'</span>)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>vectorAssembler_volatility <span class="op">=</span> VectorAssembler(inputCols <span class="op">=</span> [<span class="st">'Volatility'</span>], outputCol <span class="op">=</span> <span class="st">'vol'</span>)</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="co">#vectorAssembler_increase = VectorAssembler(inputCols = ['Increase'], outputCol = 'inc')</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> Normalizer</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="co"># normalize data </span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>normalizer <span class="op">=</span> Normalizer(inputCol <span class="op">=</span> <span class="st">'features'</span>, outputCol <span class="op">=</span> <span class="st">'features_norm'</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="co">#normalizerVol = Normalizer(inputCol = 'vol', outputCol = 'vol_norm', p = 1.0)</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>normalizerInc <span class="op">=</span> Normalizer(inputCol <span class="op">=</span> <span class="st">'inc'</span>, outputCol <span class="op">=</span> <span class="st">'inc_norm'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(stages <span class="op">=</span> [vectorAssembler_features, vectorAssembler_volatility, normalizer])</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="co">#  vectorAssembler_increase, normalizerVol, normalizerInc</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="co">#data_model = pipeline.fit(full_spark_raw)</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="co">#pipelined_data = data_model.transform(full_spark_raw)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-scrolled="true" data-execution_count="81">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>pipelined_data.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+--------------------+--------------------+--------------------+
|Unnamed: 0|year|month|day|total|postotal|negtotal|neutotal|snpcomments|fedcomments|cryptocomments| Volatility|Increase|            features|                 vol|       features_norm|
+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+--------------------+--------------------+--------------------+
|         0|2024|    3| 19|    8|       6|       2|       0|          0|          0|             3| 0.11569654|       1|[6.0,2.0,0.0,0.0,...|[0.11569654196500...|[0.85714285714285...|
|         1|2023|    9|  4|   24|      11|      11|       2|          1|          1|             6|0.010366165|       0|[11.0,11.0,2.0,1....|[0.01036616507917...|[0.65272991200661...|
|         2|2023|    6| 29|   10|       5|       5|       0|          0|          0|             0|0.051271606|       1| (6,[0,1],[5.0,5.0])|[0.05127160623669...|(6,[0,1],[0.70710...|
|         3|2023|    8| 10|   21|      14|       7|       0|          0|          0|             1|0.009294065|       0|[14.0,7.0,0.0,0.0...|[0.00929406471550...|[0.89260739828867...|
|         4|2023|    7|  4|    6|       1|       3|       2|          0|          1|             0|0.020875178|       0|[1.0,3.0,2.0,0.0,...|[0.02087517827749...|[0.25819888974716...|
|         5|2023|    8| 14|   30|      26|       3|       1|          0|          0|             3|0.012009502|       0|[26.0,3.0,1.0,0.0...|[0.01200950238853...|[0.98623621435414...|
|         6|2023|    7|  2|   10|       4|       6|       0|          0|          0|             1|0.025981873|       1|[4.0,6.0,0.0,0.0,...|[0.02598187327384...|[0.54944225579475...|
|         7|2023|    7| 20|   30|      15|      14|       1|          0|          0|             4|0.010704339|       1|[15.0,14.0,1.0,0....|[0.01070433855056...|[0.71672772385124...|
|         8|2023|    8| 31|   22|      14|       5|       3|          0|          0|             4| 0.03018702|       0|[14.0,5.0,3.0,0.0...|[0.03018702007830...|[0.89260739828867...|
|         9|2023|    7| 22|   23|      12|       8|       3|          0|          0|             1|0.020185372|       1|[12.0,8.0,3.0,0.0...|[0.02018537186086...|[0.81274255377431...|
|        10|2023|    8| 22|   25|      13|      11|       1|          0|          0|             4| 0.03821135|       1|[13.0,11.0,1.0,0....|[0.03821134939789...|[0.74194918919595...|
|        11|2023|    7|  5|    8|       3|       5|       0|          0|          1|             1|0.052260034|       0|[3.0,5.0,0.0,0.0,...|[0.05226003378629...|[0.5,0.8333333333...|
|        12|2023|    9| 16|   23|      14|       7|       2|          1|          0|             6|0.007744146|       0|[14.0,7.0,2.0,1.0...|[0.00774414604529...|[0.82783735438471...|
|        13|2024|    7|  5|    6|       2|       4|       0|          0|          0|             3| 0.04299435|       1|[2.0,4.0,0.0,0.0,...|[0.04299435019493...|[0.37139067635410...|
|        14|2023|    8| 11|   25|      15|       9|       1|          0|          0|             4|0.003582499|       1|[15.0,9.0,1.0,0.0...|[0.00358249898999...|[0.83462232611198...|
|        15|2023|    9| 23|   18|      12|       5|       1|          0|          0|             6|0.021272434|       0|[12.0,5.0,1.0,0.0...|[0.02127243392169...|[0.83607961714994...|
|        16|2023|    9| 27|   19|      11|       6|       2|          0|          0|             2|0.035808284|       1|[11.0,6.0,2.0,0.0...|[0.03580828383564...|[0.85634883857767...|
|        17|2023|    9| 11|   25|      15|      10|       0|          1|          0|             4|0.053209834|       1|[15.0,10.0,0.0,1....|[0.05320983380079...|[0.81110710565381...|
|        18|2023|    8|  9|   35|      22|      12|       1|          0|          0|             6|0.011559267|       0|[22.0,12.0,1.0,0....|[0.01155926659703...|[0.85312340776242...|
|        19|2023|    7| 26|   25|      15|       8|       2|          0|          0|             4|0.016175574|       0|[15.0,8.0,2.0,0.0...|[0.01617557369172...|[0.85332018598286...|
+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+--------------------+--------------------+--------------------+
only showing top 20 rows
</code></pre>
</div>
</div>
</section>
<section id="building-train-test-val-datasets" class="level2">
<h2 class="anchored" data-anchor-id="building-train-test-val-datasets">Building train-test-val datasets</h2>
<div class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>train_data, test_data, val_data <span class="op">=</span> full_spark_raw.randomSplit([<span class="fl">0.7</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span>], <span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'train size: '</span>, train_data.count()) </span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'test size: '</span>, test_data.count())</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">'val size: '</span>, val_data.count())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                                                                                                [Stage 10:==============&gt;                                           (1 + 3) / 4]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>train size:  290
test size:  98
val size:  36</code></pre>
</div>
</div>
<section id="fit-pipeline-on-train-data-to-avoid-information-leak" class="level3">
<h3 class="anchored" data-anchor-id="fit-pipeline-on-train-data-to-avoid-information-leak">Fit pipeline on train data to avoid information leak</h3>
<div class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(stages <span class="op">=</span> [vectorAssembler_features, vectorAssembler_volatility,  normalizer])</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="co"># normalizerVol, normalizerInc, vectorAssembler_increase,</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>fitted_pipeline <span class="op">=</span> pipeline.fit(train_data)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>train_data <span class="op">=</span> fitted_pipeline.transform(train_data)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>test_data <span class="op">=</span> fitted_pipeline.transform(test_data)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>val_data <span class="op">=</span> fitted_pipeline.transform(val_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>val_data.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>[Stage 16:&gt;                                                         (0 + 3) / 3]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+--------------------+--------------------+--------------------+
|Unnamed: 0|year|month|day|total|postotal|negtotal|neutotal|snpcomments|fedcomments|cryptocomments| Volatility|Increase|            features|                 vol|       features_norm|
+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+--------------------+--------------------+--------------------+
|         6|2023|    7|  2|   10|       4|       6|       0|          0|          0|             1|0.025981873|       1|[4.0,6.0,0.0,0.0,...|[0.02598187327384...|[0.54944225579475...|
|         8|2023|    8| 31|   22|      14|       5|       3|          0|          0|             4| 0.03018702|       0|[14.0,5.0,3.0,0.0...|[0.03018702007830...|[0.89260739828867...|
|        47|2023|    6| 22|   10|       4|       6|       0|          0|          0|             3|0.052619252|       1|[4.0,6.0,0.0,0.0,...|[0.05261925235390...|[0.51214751973158...|
|        55|2023|    9| 19|   19|      10|       9|       0|          0|          0|             3|0.019361097|       0|[10.0,9.0,0.0,0.0...|[0.01936109736561...|[0.72547625011001...|
|        77|2023|    9|  5|   25|      15|       9|       1|          1|          0|             6| 0.02352453|       0|[15.0,9.0,1.0,1.0...|[0.02352453023195...|[0.80874579902578...|
|       100|2023|    9| 22|   22|      14|       7|       1|          0|          0|             5|0.004465478|       0|[14.0,7.0,1.0,0.0...|[0.00446547800675...|[0.85043943492310...|
|       120|2023|    6|  9|   21|      11|      10|       0|          0|          0|             5| 0.03991042|       0|[11.0,10.0,0.0,0....|[0.03991042077541...|[0.70133438436967...|
|       127|2023|    9| 18|   24|      16|       6|       2|          0|          0|             5|0.030214135|       1|[16.0,6.0,2.0,0.0...|[0.03021413460373...|[0.89303291549751...|
|       161|2023|    7| 13|   13|       8|       3|       2|          0|          0|             1|0.052702334|       0|[8.0,3.0,2.0,0.0,...|[0.05270233377814...|[0.90582162731567...|
|       162|2023|    7|  8|    5|       2|       3|       0|          0|          0|             2|0.011674282|       0|[2.0,3.0,0.0,0.0,...|[0.01167428214102...|[0.48507125007266...|
|       165|2023|    6| 11|   11|       5|       6|       0|          0|          0|             1|0.017189978|       0|[5.0,6.0,0.0,0.0,...|[0.01718997769057...|[0.63500063500095...|
|       166|2023|    8| 20|   16|       9|       7|       0|          0|          0|             4|0.014130916|       0|[9.0,7.0,0.0,0.0,...|[0.01413091644644...|[0.74484529974213...|
|       174|2023|    9|  6|   27|      17|       9|       1|          0|          1|             4| 0.03071667|       1|[17.0,9.0,1.0,0.0...|[0.03071667067706...|[0.86304424036357...|
|       191|2024|    3| 25|    7|       5|       2|       0|          0|          0|             0|0.030392166|       1| (6,[0,1],[5.0,2.0])|[0.03039216622710...|(6,[0,1],[0.92847...|
|       198|2023|   10| 22|    4|       1|       2|       1|          0|          0|             0| 0.14955209|       1|[1.0,2.0,1.0,0.0,...|[0.1495520919561386]|[0.40824829046386...|
|       221|2023|   12| 30|    4|       2|       2|       0|          0|          0|             3|0.021532169|       1|[2.0,2.0,0.0,0.0,...|[0.02153216861188...|[0.48507125007266...|
|       222|2024|    4| 23|    4|       3|       1|       0|          0|          0|             2|0.052000377|       0|[3.0,1.0,0.0,0.0,...|[0.05200037732720...|[0.80178372573727...|
|       223|2023|   11| 26|    5|       3|       1|       1|          0|          0|             2| 0.02167586|       0|[3.0,1.0,1.0,0.0,...|[0.02167586050927...|[0.77459666924148...|
|       240|2024|    2| 22|    5|       4|       1|       0|          0|          0|             0|0.019385979|       0| (6,[0,1],[4.0,1.0])|[0.01938597857952...|(6,[0,1],[0.97014...|
|       245|2024|    4| 14|    4|       2|       2|       0|          0|          0|             0|0.067364216|       0| (6,[0,1],[2.0,2.0])|[0.06736421585083...|(6,[0,1],[0.70710...|
+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+--------------------+--------------------+--------------------+
only showing top 20 rows
</code></pre>
</div>
</div>
</section>
</section>
<section id="build-classification-models-logistic-regression-gbt" class="level2">
<h2 class="anchored" data-anchor-id="build-classification-models-logistic-regression-gbt">Build Classification Models (logistic regression, GBT)</h2>
<section id="lr" class="level4">
<h4 class="anchored" data-anchor-id="lr">LR</h4>
<div class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.classification <span class="im">import</span> LogisticRegression</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.classification <span class="im">import</span> GBTClassifier</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> MulticlassClassificationEvaluator</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> LogisticRegression(maxIter<span class="op">=</span><span class="dv">10</span>, regParam<span class="op">=</span><span class="fl">0.3</span>, elasticNetParam<span class="op">=</span><span class="fl">0.8</span>, featuresCol<span class="op">=</span><span class="st">'features_norm'</span>,labelCol <span class="op">=</span> <span class="st">'Increase'</span>)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>lrModel <span class="op">=</span> lr.fit(train_data)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Print the coefficients and intercept for logistic regression</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Coefficients: "</span> <span class="op">+</span> <span class="bu">str</span>(lrModel.coefficients))</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Intercept: "</span> <span class="op">+</span> <span class="bu">str</span>(lrModel.intercept))</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Coefficients: (6,[],[])
Intercept: 0.1937068790190799</code></pre>
</div>
</div>
<div class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eval_results_binary(df, model, real <span class="op">=</span> <span class="st">'Increase'</span>, pred <span class="op">=</span> <span class="st">'prediction'</span>):</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> model.transform(df)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    evaluator <span class="op">=</span> MulticlassClassificationEvaluator(labelCol<span class="op">=</span>real, predictionCol<span class="op">=</span>pred, metricName<span class="op">=</span><span class="st">"accuracy"</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> evaluator.evaluate(preds)</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Accuracy = </span><span class="sc">%g</span><span class="st">"</span> <span class="op">%</span> accuracy)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Train Error = </span><span class="sc">%g</span><span class="st">"</span> <span class="op">%</span> (<span class="fl">1.0</span> <span class="op">-</span> accuracy))</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> LogisticRegression(maxIter<span class="op">=</span><span class="dv">10</span>, regParam<span class="op">=</span><span class="fl">0.5</span>, elasticNetParam<span class="op">=</span><span class="fl">0.1</span>, featuresCol<span class="op">=</span><span class="st">'features_norm'</span>,labelCol <span class="op">=</span> <span class="st">'Increase'</span>)</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>lrModel <span class="op">=</span> lr.fit(train_data)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>eval_results_binary(train_data, lrModel)</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>eval_results_binary(test_data, lrModel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                [Stage 5001:============================&gt;                           (2 + 2) / 4]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy = 0.548276
Train Error = 0.451724
Accuracy = 0.438776
Train Error = 0.561224</code></pre>
</div>
</div>
</section>
<section id="lr-with-hyperparameter-search" class="level4">
<h4 class="anchored" data-anchor-id="lr-with-hyperparameter-search">LR with Hyperparameter Search</h4>
<div class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.tuning <span class="im">import</span> ParamGridBuilder, TrainValidationSplit, CrossValidator</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator, BinaryClassificationEvaluator</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># fix label column name</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>train_data_cv <span class="op">=</span> train_data.withColumn(<span class="st">'label'</span>, f.col(<span class="st">'Increase'</span>))</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>paramGrid <span class="op">=</span> ParamGridBuilder()<span class="op">\</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    .addGrid(lr.regParam, [<span class="fl">0.3</span>,<span class="fl">0.2</span>, <span class="fl">0.1</span>, <span class="fl">0.01</span>]) <span class="op">\</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>    .addGrid(lr.fitIntercept, [<span class="va">False</span>, <span class="va">True</span>])<span class="op">\</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>    .addGrid(lr.elasticNetParam, [<span class="fl">0.0</span>, <span class="fl">0.5</span>, <span class="fl">1.0</span>])<span class="op">\</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>    .build()</span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="co"># devalre model</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>lr_cv <span class="op">=</span> LogisticRegression(maxIter<span class="op">=</span><span class="dv">10</span>, regParam<span class="op">=</span><span class="fl">0.5</span>, elasticNetParam<span class="op">=</span><span class="fl">0.1</span>, featuresCol<span class="op">=</span><span class="st">'features_norm'</span>,labelCol <span class="op">=</span> <span class="st">'Increase'</span>)</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>crossval <span class="op">=</span> CrossValidator(estimator<span class="op">=</span>lr_cv,</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>                      estimatorParamMaps<span class="op">=</span>paramGrid,</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>                      evaluator<span class="op">=</span>RegressionEvaluator(),</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>                      numFolds<span class="op">=</span><span class="dv">2</span>)  </span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="co">"""# In this case the estimator is simply the linear regression.</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="co"># A TrainValidationSplit requires an Estimator, a set of Estimator ParamMaps, and an Evaluator.</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="co">tvs = TrainValidationSplit(estimator=lr,</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a><span class="co">                           estimatorParamMaps=paramGrid,</span></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="co">                           evaluator=RegressionEvaluator(),</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="co">                           # 80% of the data will be used for training, 20% for validation.</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a><span class="co">                           trainRatio=0.8)"""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>'# In this case the estimator is simply the linear regression.\n# A TrainValidationSplit requires an Estimator, a set of Estimator ParamMaps, and an Evaluator.\ntvs = TrainValidationSplit(estimator=lr,\n                           estimatorParamMaps=paramGrid,\n                           evaluator=RegressionEvaluator(),\n                           # 80% of the data will be used for training, 20% for validation.\n                           trainRatio=0.8)'</code></pre>
</div>
</div>
<div class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>tuned_lr_model <span class="op">=</span> crossval.fit(train_data_cv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="co">#tuned_lr_model.explainParam('fitIntercept')</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>eval_results_binary(train_data, tuned_lr_model.bestModel)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>eval_results_binary(test_data, tuned_lr_model.bestModel)</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tuned_lr_model.bestModel.explainParam(<span class="st">'regParam'</span>))</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tuned_lr_model.bestModel.explainParam(<span class="st">'fitIntercept'</span>))</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tuned_lr_model.bestModel.explainParam(<span class="st">'elasticNetParam'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                [Stage 4995:&gt;                                                       (0 + 4) / 4]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy = 0.548276
Train Error = 0.451724
Accuracy = 0.438776
Train Error = 0.561224
regParam: regularization parameter (&gt;= 0). (default: 0.0, current: 0.5)
fitIntercept: whether to fit an intercept term. (default: True)
elasticNetParam: the ElasticNet mixing parameter, in range [0, 1]. For alpha = 0, the penalty is an L2 penalty. For alpha = 1, it is an L1 penalty. (default: 0.0, current: 0.1)</code></pre>
</div>
</div>
<p>best params: reg 0.5, intercept fit = true, elastic net = 0.1.</p>
</section>
<section id="gbt-without-tuning" class="level4">
<h4 class="anchored" data-anchor-id="gbt-without-tuning">GBT without tuning</h4>
<div class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>gbt <span class="op">=</span> GBTClassifier(labelCol<span class="op">=</span><span class="st">"Increase"</span>, featuresCol<span class="op">=</span><span class="st">"features_norm"</span>, maxIter<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>gbt_model <span class="op">=</span> gbt.fit(train_data)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>eval_results_binary(train_data, gbt_model)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>eval_results_binary(test_data, gbt_model)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy = 0.827586
Train Error = 0.172414
Accuracy = 0.438776
Train Error = 0.561224</code></pre>
</div>
</div>
<p>massive overfitting</p>
</section>
<section id="gbt-with-tuning" class="level4">
<h4 class="anchored" data-anchor-id="gbt-with-tuning">GBT with tuning</h4>
<div class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>test_data_cv <span class="op">=</span> test_data.withColumn(<span class="st">'label'</span>, f.col(<span class="st">'Increase'</span>))</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>gbt <span class="op">=</span> GBTClassifier(labelCol<span class="op">=</span><span class="st">"Increase"</span>, featuresCol<span class="op">=</span><span class="st">"features_norm"</span>, maxIter<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>paramGrid_gbt <span class="op">=</span> ParamGridBuilder()<span class="op">\</span></span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a>    .addGrid(gbt.maxDepth, [<span class="dv">5</span>,<span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">2</span>]) <span class="op">\</span></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    .addGrid(gbt.minInstancesPerNode, [<span class="dv">1</span>, <span class="dv">2</span>,<span class="dv">3</span>])<span class="op">\</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    .addGrid(gbt.minInfoGain, [<span class="fl">0.0</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>])<span class="op">\</span></span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    .build()</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>crossval_gbt <span class="op">=</span> CrossValidator(estimator<span class="op">=</span>gbt,</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a>                      estimatorParamMaps<span class="op">=</span>paramGrid_gbt,</span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>                      evaluator<span class="op">=</span>BinaryClassificationEvaluator(),</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a>                      numFolds<span class="op">=</span><span class="dv">2</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>tuned_gbt_model <span class="op">=</span> crossval_gbt.fit(train_data_cv)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>eval_results_binary(train_data, gbt_model)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>eval_results_binary(test_data, gbt_model)</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>eval_results_binary(train_data, tuned_gbt_model.bestModel)</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>eval_results_binary(test_data, tuned_gbt_model.bestModel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                                                                                                                                                                                [Stage 4991:==========================================&gt;             (3 + 1) / 4]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy = 0.827586
Train Error = 0.172414
Accuracy = 0.438776
Train Error = 0.561224
Accuracy = 0.475862
Train Error = 0.524138
Accuracy = 0.785714
Train Error = 0.214286</code></pre>
</div>
</div>
<div class="cell" data-execution_count="164">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tuned_gbt_model.bestModel.explainParam(<span class="st">'maxDepth'</span>))</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tuned_gbt_model.bestModel.explainParam(<span class="st">'minInstancesPerNode'</span>))</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tuned_gbt_model.bestModel.explainParam(<span class="st">'minInfoGain'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>maxDepth: Maximum depth of the tree. (&gt;= 0) E.g., depth 0 means 1 leaf node; depth 1 means 1 internal node + 2 leaf nodes. Must be in range [0, 30]. (default: 5, current: 5)
minInstancesPerNode: Minimum number of instances each child must have after split. If a split causes the left or right child to have fewer than minInstancesPerNode, the split will be discarded as invalid. Should be &gt;= 1. (default: 1, current: 2)
minInfoGain: Minimum information gain for a split to be considered at a tree node. (default: 0.0, current: 0.0)</code></pre>
</div>
</div>
<p>best results were depth 5, min instances 2, min info gain 0</p>
</section>
<section id="classification-evaluation-metrics" class="level3">
<h3 class="anchored" data-anchor-id="classification-evaluation-metrics">Classification Evaluation Metrics</h3>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.mllib.evaluation <span class="im">import</span> BinaryClassificationMetrics</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="166">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CurveMetrics(BinaryClassificationMetrics):</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, <span class="op">*</span>args):</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(CurveMetrics, <span class="va">self</span>).<span class="fu">__init__</span>(<span class="op">*</span>args)</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-5"><a href="#cb62-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> _to_list(<span class="va">self</span>, rdd):</span>
<span id="cb62-6"><a href="#cb62-6" aria-hidden="true" tabindex="-1"></a>        points <span class="op">=</span> []</span>
<span id="cb62-7"><a href="#cb62-7" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Note this collect could be inefficient for large datasets </span></span>
<span id="cb62-8"><a href="#cb62-8" aria-hidden="true" tabindex="-1"></a>        <span class="co"># considering there may be one probability per datapoint (at most)</span></span>
<span id="cb62-9"><a href="#cb62-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># The Scala version takes a numBins parameter, </span></span>
<span id="cb62-10"><a href="#cb62-10" aria-hidden="true" tabindex="-1"></a>        <span class="co"># but it doesn't seem possible to pass this from Python to Java</span></span>
<span id="cb62-11"><a href="#cb62-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> row <span class="kw">in</span> rdd.collect():</span>
<span id="cb62-12"><a href="#cb62-12" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Results are returned as type scala.Tuple2, </span></span>
<span id="cb62-13"><a href="#cb62-13" aria-hidden="true" tabindex="-1"></a>            <span class="co"># which doesn't appear to have a py4j mapping</span></span>
<span id="cb62-14"><a href="#cb62-14" aria-hidden="true" tabindex="-1"></a>            points <span class="op">+=</span> [(<span class="bu">float</span>(row._1()), <span class="bu">float</span>(row._2()))]</span>
<span id="cb62-15"><a href="#cb62-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> points</span>
<span id="cb62-16"><a href="#cb62-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb62-17"><a href="#cb62-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_curve(<span class="va">self</span>, method):</span>
<span id="cb62-18"><a href="#cb62-18" aria-hidden="true" tabindex="-1"></a>        rdd <span class="op">=</span> <span class="bu">getattr</span>(<span class="va">self</span>._java_model, method)().toJavaRDD()</span>
<span id="cb62-19"><a href="#cb62-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._to_list(rdd)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-jupyter="{&quot;outputs_hidden&quot;:true}" data-scrolled="true" data-execution_count="169">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>predictions.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+--------------------+--------------------+--------------------+--------------------+--------------------+----------+
|Unnamed: 0|year|month|day|total|postotal|negtotal|neutotal|snpcomments|fedcomments|cryptocomments| Volatility|Increase|            features|                 vol|       features_norm|       rawPrediction|         probability|prediction|
+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+--------------------+--------------------+--------------------+--------------------+--------------------+----------+
|         2|2023|    6| 29|   10|       5|       5|       0|          0|          0|             0|0.051271606|       1| (6,[0,1],[5.0,5.0])|[0.05127160623669...|(6,[0,1],[0.70710...|[0.04072378081366...|[0.52035064163719...|       0.0|
|         9|2023|    7| 22|   23|      12|       8|       3|          0|          0|             1|0.020185372|       1|[12.0,8.0,3.0,0.0...|[0.02018537186086...|[0.81274255377431...|[-0.7361010373105...|[0.18660814018841...|       1.0|
|        13|2024|    7|  5|    6|       2|       4|       0|          0|          0|             3| 0.04299435|       1|[2.0,4.0,0.0,0.0,...|[0.04299435019493...|[0.37139067635410...|[-0.1529128864276...|[0.42413394598506...|       1.0|
|        14|2023|    8| 11|   25|      15|       9|       1|          0|          0|             4|0.003582499|       1|[15.0,9.0,1.0,0.0...|[0.00358249898999...|[0.83462232611198...|[-0.6753426955932...|[0.20575834131895...|       1.0|
|        15|2023|    9| 23|   18|      12|       5|       1|          0|          0|             6|0.021272434|       0|[12.0,5.0,1.0,0.0...|[0.02127243392169...|[0.83607961714994...|[0.36261892673148...|[0.67375938363221...|       0.0|
|        19|2023|    7| 26|   25|      15|       8|       2|          0|          0|             4|0.016175574|       0|[15.0,8.0,2.0,0.0...|[0.01617557369172...|[0.85332018598286...|[0.10030486553126...|[0.54998491126510...|       0.0|
|        21|2023|    7| 28|   17|      12|       3|       2|          0|          0|             5|0.004884871|       1|[12.0,3.0,2.0,0.0...|[0.00488487118855...|[0.88949917999332...|[0.16334880911301...|[0.58095564020636...|       0.0|
|        23|2023|    9| 20|   23|      10|      13|       0|          0|          0|             5|0.028508546|       0|[10.0,13.0,0.0,0....|[0.02850854583084...|[0.58321184351980...|[0.04050837598431...|[0.52024311670070...|       0.0|
|        24|2023|    6|  3|   11|       5|       6|       0|          0|          0|             2| 0.01677447|       1|[5.0,6.0,0.0,0.0,...|[0.01677446998655...|[0.62017367294604...|[1.23295505714401...|[0.92171716920551...|       0.0|
|        28|2023|    7| 21|   26|      12|      12|       2|          0|          1|             3|0.011058536|       0|[12.0,12.0,2.0,0....|[0.01105853635817...|[0.69052240517812...|[1.26820819127500...|[0.92665563822624...|       0.0|
|        29|2023|   12|  8|   12|       9|       3|       0|          1|          0|             2|0.016837386|       0|[9.0,3.0,0.0,1.0,...|[0.01683738641440...|[0.92338051687663...|[0.52726781183063...|[0.74164491181732...|       0.0|
|        30|2023|    7|  7|   13|       8|       5|       0|          0|          0|             1|0.010676579|       0|[8.0,5.0,0.0,0.0,...|[0.01067657861858...|[0.84327404271156...|[-0.0590892792101...|[0.47048969789841...|       1.0|
|        32|2024|    3|  5|   13|      10|       3|       0|          0|          0|             3|0.074554786|       1|[10.0,3.0,0.0,0.0...|[0.07455478608608...|[0.92057461789832...|[-0.6682806879796...|[0.20807610777871...|       1.0|
|        34|2023|   10| 19|    6|       4|       1|       1|          0|          0|             1|0.054999303|       1|[4.0,1.0,1.0,0.0,...|[0.05499930307269...|[0.91766293548224...|[-0.4394189538902...|[0.29341865083119...|       1.0|
|        35|2023|    8|  3|   17|       6|      10|       1|          0|          0|             4|0.015187176|       0|[6.0,10.0,1.0,0.0...|[0.01518717594444...|[0.48507125007266...|[-0.9201703097821...|[0.13701101308056...|       1.0|
|        39|2023|    8| 15|   27|      17|      10|       0|          0|          0|             6| 0.01827349|       0|[17.0,10.0,0.0,0....|[0.01827348954975...|[0.82462112512353...|[0.21149793044922...|[0.60419991034895...|       0.0|
|        42|2023|    8|  8|   23|      15|       8|       0|          0|          0|             2|0.024177648|       0|[15.0,8.0,0.0,0.0...|[0.02417764812707...|[0.87630935675547...|[-0.0388693196488...|[0.48057512171456...|       1.0|
|        43|2023|    8| 28|   21|      14|       4|       3|          0|          0|             4|0.081407145|       1|[14.0,4.0,3.0,0.0...|[0.08140714466571...|[0.90939772344628...|[-0.4394189538902...|[0.29341865083119...|       1.0|
|        45|2023|    9| 25|   15|       6|       8|       1|          0|          0|             2|0.011511951|       0|[6.0,8.0,1.0,0.0,...|[0.01151195075362...|[0.58554004376911...|[-1.1215306613341...|[0.09594966373682...|       1.0|
|        46|2023|    6| 19|    7|       5|       2|       0|          0|          0|             1| 0.06434874|       1|[5.0,2.0,0.0,0.0,...|[0.0643487423658371]|[0.91287092917527...|[0.35156128078979...|[0.66887972031075...|       0.0|
+----------+----+-----+---+-----+--------+--------+--------+-----------+-----------+--------------+-----------+--------+--------------------+--------------------+--------------------+--------------------+--------------------+----------+
only showing top 20 rows
</code></pre>
</div>
</div>
<div class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a Pipeline estimator and fit on train DF, predict on test DF</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="co">#model = gbt_model.fit(train_data)</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> gbt_model.transform(test_data)</span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Returns as a list (false positive rate, true positive rate)</span></span>
<span id="cb65-8"><a href="#cb65-8" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> predictions.select(<span class="st">'prediction'</span>,<span class="st">'probability'</span>).rdd.<span class="bu">map</span>(<span class="kw">lambda</span> row: (<span class="bu">float</span>(row[<span class="st">'probability'</span>][<span class="dv">1</span>]), <span class="bu">float</span>(row[<span class="st">'prediction'</span>])))</span>
<span id="cb65-9"><a href="#cb65-9" aria-hidden="true" tabindex="-1"></a>points <span class="op">=</span> CurveMetrics(preds).get_curve(<span class="st">'roc'</span>)</span>
<span id="cb65-10"><a href="#cb65-10" aria-hidden="true" tabindex="-1"></a>roc <span class="op">=</span> CurveMetrics(preds).get_curve(<span class="st">'roc'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>NameError: name 'CurveMetrics' is not defined</code></pre>
</div>
</div>
<div class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> roc_curve, RocCurveDisplay, auc</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.functions <span class="im">import</span> vector_to_array</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-4"><a href="#cb67-4" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> gbt_model.transform(test_data)</span>
<span id="cb67-5"><a href="#cb67-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb67-6"><a href="#cb67-6" aria-hidden="true" tabindex="-1"></a>y_score <span class="op">=</span> predictions.select(vector_to_array(<span class="st">"probability"</span>)[<span class="dv">1</span>]).rdd.keys().collect()</span>
<span id="cb67-7"><a href="#cb67-7" aria-hidden="true" tabindex="-1"></a>y_true <span class="op">=</span> predictions.select(<span class="st">"Increase"</span>).rdd.keys().collect()</span>
<span id="cb67-8"><a href="#cb67-8" aria-hidden="true" tabindex="-1"></a>fpr, tpr, thresholds <span class="op">=</span> roc_curve(y_true, y_score)</span>
<span id="cb67-9"><a href="#cb67-9" aria-hidden="true" tabindex="-1"></a>roc_auc <span class="op">=</span> auc(fpr, tpr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> ROC_curve(model, data):</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    preds <span class="op">=</span> model.transform(data)</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>    y_score <span class="op">=</span> preds.select(vector_to_array(<span class="st">"probability"</span>)[<span class="dv">1</span>]).rdd.keys().collect()</span>
<span id="cb69-6"><a href="#cb69-6" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> preds.select(<span class="st">"Increase"</span>).rdd.keys().collect()</span>
<span id="cb69-7"><a href="#cb69-7" aria-hidden="true" tabindex="-1"></a>    fpr, tpr, thresholds <span class="op">=</span> roc_curve(y_true, y_score)</span>
<span id="cb69-8"><a href="#cb69-8" aria-hidden="true" tabindex="-1"></a>    roc_auc <span class="op">=</span> auc(fpr, tpr)</span>
<span id="cb69-9"><a href="#cb69-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fpr, tpr, thresholds, roc_auc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>fpr_gbt, tpr_gbt, thresholds_gbt, roc_auc_gbt <span class="op">=</span> ROC_curve(gbt_model, test_data)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>fpr_gbt_tuned, tpr_gbt_tuned, thresholds_gbt_tuned, roc_auc_gbt_tuned <span class="op">=</span> ROC_curve(tuned_gbt_model.bestModel, val_data)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>fpr_lr, tpr_lr, thresholds_lr, roc_auc_lr <span class="op">=</span> ROC_curve(lrModel, test_data)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>fpr_lr_tuned, tpr_lr_tuned, thresholds_lr_tuned, roc_auc_lr_tuned <span class="op">=</span> ROC_curve(tuned_lr_model.bestModel, test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>plt.figure()  </span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>plt.plot(fpr_gbt, tpr_gbt, label<span class="op">=</span><span class="st">'GBT (area = </span><span class="sc">%0.2f</span><span class="st">)'</span> <span class="op">%</span> roc_auc_gbt)</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>plt.plot(fpr_gbt_tuned, tpr_gbt_tuned, label<span class="op">=</span><span class="st">'GBT Tuned (area = </span><span class="sc">%0.2f</span><span class="st">)'</span> <span class="op">%</span> roc_auc_gbt_tuned)</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.plot(fpr_lr, tpr_lr, thresholds_lr, label='Log Reg. (area = %0.2f)' % roc_auc_lr)</span></span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a><span class="co">#plt.plot(fpr_lr_tuned, tpr_lr_tuned, label='Log Reg. Tuned (area = %0.2f)' % roc_auc_lr_tuned)</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'k--'</span>, label<span class="op">=</span><span class="st">'No Skill'</span>)</span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a>plt.xlim([<span class="fl">0.0</span>, <span class="fl">1.0</span>])</span>
<span id="cb72-9"><a href="#cb72-9" aria-hidden="true" tabindex="-1"></a>plt.ylim([<span class="fl">0.0</span>, <span class="fl">1.05</span>])</span>
<span id="cb72-10"><a href="#cb72-10" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'False Positive Rate'</span>)</span>
<span id="cb72-11"><a href="#cb72-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'True Positive Rate'</span>)</span>
<span id="cb72-12"><a href="#cb72-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'ROC Curve for GBT Models'</span>)</span>
<span id="cb72-13"><a href="#cb72-13" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb72-14"><a href="#cb72-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ml_copy_files/figure-html/cell-41-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>plt.figure()  </span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>plt.plot(fpr_lr, tpr_lr<span class="op">+</span><span class="fl">.01</span>, label<span class="op">=</span><span class="st">'Logistic Reg. (area = </span><span class="sc">%0.2f</span><span class="st">)'</span> <span class="op">%</span> roc_auc_lr)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>plt.plot(fpr_lr_tuned, tpr_lr_tuned<span class="op">-</span><span class="fl">.01</span>, label<span class="op">=</span><span class="st">'Logistic Reg. Tuned (area = </span><span class="sc">%0.2f</span><span class="st">)'</span> <span class="op">%</span> roc_auc_lr_tuned)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'k--'</span>, label<span class="op">=</span><span class="st">'No Skill'</span>)</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>plt.xlim([<span class="fl">0.0</span>, <span class="fl">1.0</span>])</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>plt.ylim([<span class="fl">0.0</span>, <span class="fl">1.05</span>])</span>
<span id="cb73-10"><a href="#cb73-10" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'False Positive Rate'</span>)</span>
<span id="cb73-11"><a href="#cb73-11" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'True Positive Rate'</span>)</span>
<span id="cb73-12"><a href="#cb73-12" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'ROC Curve for Logistic Regression Models'</span>)</span>
<span id="cb73-13"><a href="#cb73-13" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb73-14"><a href="#cb73-14" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ml_copy_files/figure-html/cell-42-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="build-regression-models" class="level2">
<h2 class="anchored" data-anchor-id="build-regression-models">Build Regression Models</h2>
<section id="linear-regression" class="level3">
<h3 class="anchored" data-anchor-id="linear-regression">Linear Regression</h3>
<div class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> LinearRegression</span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> GBTRegressor</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> GBTRegressor</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>train_data_cv <span class="op">=</span> train_data.withColumn(<span class="st">'label'</span>, f.col(<span class="st">'Increase'</span>))</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> LinearRegression(featuresCol<span class="op">=</span><span class="st">"features_norm"</span>, labelCol<span class="op">=</span><span class="st">"Volatility"</span>, predictionCol<span class="op">=</span><span class="st">"predicted_vol"</span>, regParam<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>lr_model <span class="op">=</span> lr.fit(train_data)</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> lr_model.transform(test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> eval_results_reg(model, testdf, labels <span class="op">=</span> <span class="st">'Volatility'</span>, predcol <span class="op">=</span> <span class="st">'predicted_vol'</span>):</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a>    predictions <span class="op">=</span> model.transform(testdf)</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    evaluator <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"Volatility"</span>, predictionCol<span class="op">=</span><span class="st">"predicted_vol"</span>, metricName<span class="op">=</span><span class="st">"rmse"</span>)</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    rmse <span class="op">=</span> evaluator.evaluate(predictions)</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>    evaluator_r2 <span class="op">=</span> RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"Volatility"</span>, predictionCol<span class="op">=</span><span class="st">"predicted_vol"</span>, metricName<span class="op">=</span><span class="st">"r2"</span>)</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>    r2 <span class="op">=</span> evaluator_r2.evaluate(predictions)</span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'rmse: '</span>, rmse) </span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'r2: '</span>, r2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>eval_results_reg(lr_model, train_data)</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>eval_results_reg(lr_model, test_data)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                [Stage 13850:===========================&gt;                           (2 + 2) / 4]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>rmse:  0.02220339615429509
r2:  0.008431300143542875
rmse:  0.02213137254223798
r2:  0.0009947192877705069</code></pre>
</div>
</div>
<section id="tuned-hyperparameters" class="level4">
<h4 class="anchored" data-anchor-id="tuned-hyperparameters">Tuned Hyperparameters</h4>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> LinearRegression(featuresCol<span class="op">=</span><span class="st">"features_norm"</span>, labelCol<span class="op">=</span><span class="st">"Volatility"</span>, predictionCol<span class="op">=</span><span class="st">"predicted_vol"</span>)</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>paramGrid_linreg <span class="op">=</span> ParamGridBuilder()<span class="op">\</span></span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>    .addGrid(lr.regParam, [<span class="fl">0.0</span>,<span class="fl">0.1</span>,<span class="fl">0.2</span>]) <span class="op">\</span></span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>    .addGrid(lr.elasticNetParam, [<span class="fl">0.2</span>, <span class="fl">0.4</span>, <span class="fl">0.6</span>, <span class="fl">0.8</span>])<span class="op">\</span></span>
<span id="cb81-7"><a href="#cb81-7" aria-hidden="true" tabindex="-1"></a>    .build()</span>
<span id="cb81-8"><a href="#cb81-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-9"><a href="#cb81-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb81-10"><a href="#cb81-10" aria-hidden="true" tabindex="-1"></a>crossval_linreg <span class="op">=</span> CrossValidator(estimator<span class="op">=</span>lr,</span>
<span id="cb81-11"><a href="#cb81-11" aria-hidden="true" tabindex="-1"></a>                      estimatorParamMaps<span class="op">=</span>paramGrid_linreg,</span>
<span id="cb81-12"><a href="#cb81-12" aria-hidden="true" tabindex="-1"></a>                      evaluator<span class="op">=</span>RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"Volatility"</span>, predictionCol<span class="op">=</span><span class="st">"predicted_vol"</span>, metricName<span class="op">=</span><span class="st">"r2"</span>),</span>
<span id="cb81-13"><a href="#cb81-13" aria-hidden="true" tabindex="-1"></a>                      numFolds<span class="op">=</span><span class="dv">3</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>tuned_linreg_model <span class="op">=</span> crossval_linreg.fit(train_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>24/12/07 07:01:43 WARN Instrumentation: [96f402a2] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:45 WARN Instrumentation: [d4c8098b] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:45 WARN Instrumentation: [1f98621c] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:46 WARN Instrumentation: [ce5c9fe2] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:48 WARN Instrumentation: [0bb4ce86] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:50 WARN Instrumentation: [cd12cb60] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:51 WARN Instrumentation: [fa4dbcc2] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:51 WARN Instrumentation: [f5ee3758] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:53 WARN Instrumentation: [ccc08602] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:55 WARN Instrumentation: [d6462d1b] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:55 WARN Instrumentation: [e872d0fb] regParam is zero, which might cause numerical instability and overfitting.
24/12/07 07:01:56 WARN Instrumentation: [013e0f0d] regParam is zero, which might cause numerical instability and overfitting.
                                                                                </code></pre>
</div>
</div>
<div class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>eval_results_reg(tuned_linreg_model, train_data)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>eval_results_reg(tuned_linreg_model, test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                                                                                                                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>rmse:  0.022297593980785187
r2:  3.3306690738754696e-16
rmse:  0.02216353106124524
r2:  -0.0019106469616598787</code></pre>
</div>
</div>
<div class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tuned_linreg_model.bestModel.explainParam(<span class="st">'regParam'</span>))</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tuned_linreg_model.bestModel.explainParam(<span class="st">'elasticNetParam'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>regParam: regularization parameter (&gt;= 0). (default: 0.0, current: 0.2)
elasticNetParam: the ElasticNet mixing parameter, in range [0, 1]. For alpha = 0, the penalty is an L2 penalty. For alpha = 1, it is an L1 penalty. (default: 0.0, current: 0.2)</code></pre>
</div>
</div>
<div class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(lr_model.coefficients)</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(tuned_linreg_model.bestModel.intercept)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[-0.0006648945929220134,-0.0006146639773429391,-0.000992980630497191,0.006169592546959767,0.000871323960578097,0.002031770773261513]
0.03420036530507536</code></pre>
</div>
</div>
</section>
</section>
<section id="gradient-boosted-regressor" class="level3">
<h3 class="anchored" data-anchor-id="gradient-boosted-regressor">Gradient Boosted Regressor</h3>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>gbr <span class="op">=</span> GBTRegressor(featuresCol<span class="op">=</span><span class="st">"features_norm"</span>, labelCol<span class="op">=</span><span class="st">"Volatility"</span>, predictionCol<span class="op">=</span><span class="st">"predicted_vol"</span>, maxIter<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>gbr_model <span class="op">=</span> gbr.fit(train_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>eval_results_reg(gbr_model, train_data)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>eval_results_reg(gbr_model, test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                [Stage 13858:&gt;                                                      (0 + 4) / 4]                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>rmse:  0.015124025795236173
r2:  0.5399354050685081
rmse:  0.02540514560521019
r2:  -0.31641997320583726</code></pre>
</div>
</div>
<div class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>gbr <span class="op">=</span> GBTRegressor(featuresCol<span class="op">=</span><span class="st">"features_norm"</span>, labelCol<span class="op">=</span><span class="st">"Volatility"</span>, predictionCol<span class="op">=</span><span class="st">"predicted_vol"</span>, maxIter<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>paramGrid_gbr <span class="op">=</span> ParamGridBuilder()<span class="op">\</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>    .addGrid(gbr.maxDepth, [<span class="dv">6</span>, <span class="dv">5</span>,<span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">2</span>]) <span class="op">\</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>    .addGrid(gbr.minInstancesPerNode, [<span class="dv">1</span>, <span class="dv">2</span>,<span class="dv">3</span>])<span class="op">\</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>    .addGrid(gbr.minInfoGain, [<span class="fl">0.0</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>])<span class="op">\</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>    .build()</span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb96-11"><a href="#cb96-11" aria-hidden="true" tabindex="-1"></a>crossval_gbr <span class="op">=</span> CrossValidator(estimator<span class="op">=</span>gbr,</span>
<span id="cb96-12"><a href="#cb96-12" aria-hidden="true" tabindex="-1"></a>                      estimatorParamMaps<span class="op">=</span>paramGrid_gbr,</span>
<span id="cb96-13"><a href="#cb96-13" aria-hidden="true" tabindex="-1"></a>                      evaluator<span class="op">=</span>RegressionEvaluator(labelCol<span class="op">=</span><span class="st">"Volatility"</span>, predictionCol<span class="op">=</span><span class="st">"predicted_vol"</span>, metricName<span class="op">=</span><span class="st">"r2"</span>),</span>
<span id="cb96-14"><a href="#cb96-14" aria-hidden="true" tabindex="-1"></a>                      numFolds<span class="op">=</span><span class="dv">2</span>)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>tuned_gbr_model <span class="op">=</span> crossval_gbr.fit(train_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a>eval_results_reg(tuned_gbr_model.bestModel, train_data)</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>eval_results_reg(tuned_gbr_model.bestModel, test_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                                                                                                                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>rmse:  0.022297593980785187
r2:  3.3306690738754696e-16
rmse:  0.02216353106124524
r2:  -0.0019106469616601007</code></pre>
</div>
</div>
<div class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>predictions <span class="op">=</span> gbr_model.transform(test_data)</span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a>predictions2 <span class="op">=</span> lr_model.transform(test_data)</span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>x_ax <span class="op">=</span> <span class="bu">range</span>(<span class="dv">0</span>, predictions.count())</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>y_pred_gbr <span class="op">=</span> predictions.select(<span class="st">"predicted_vol"</span>).collect()</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a>y_pred_lr <span class="op">=</span> predictions2.select(<span class="st">"predicted_vol"</span>).collect()</span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a>y_orig <span class="op">=</span> predictions.select(<span class="st">"Volatility"</span>).collect()  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
</div>
<div class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>plt.plot(x_ax, y_orig, label<span class="op">=</span><span class="st">"Original"</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>plt.plot(x_ax, y_pred_gbr, label<span class="op">=</span><span class="st">"Predicted - GBR"</span>)</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>plt.plot(x_ax, y_pred_lr, label<span class="op">=</span><span class="st">"Predicted - LR"</span>)</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">"Predicted vs. Real Volatility (Test Set)"</span>)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Index'</span>)</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Volatility (</span><span class="sc">% o</span><span class="st">f Open Price)'</span>)</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>plt.legend(loc<span class="op">=</span><span class="st">'best'</span>,fancybox<span class="op">=</span><span class="va">True</span>, shadow<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="ml_copy_files/figure-html/cell-58-output-1.png" class="img-fluid"></p>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">Content 2023 by [Project Team 1] <br> All content licensed under a <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International license (CC BY-NC 4.0)</a></div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">Made with and <a href="https://quarto.org/">Quarto</a><br> <a href="https://github.com/anly503/lab-2.1">View the source at GitHub</a></div>
  </div>
</footer>



</body></html>